# 安卓端与后端功能模块交互说明

**注：该文档为功能及逻辑实现的初步说明，对于具体的接口及相关参数，将在后续沟通中一一说明。**

## 1  基本信息模块

### 1.1  APP使用对象

我们的宿舍管理系统的安卓端主要面向的使用者为**宿舍管理员**，即宿管阿姨/叔叔，不涉及学生登陆。

宿舍管理员通过登陆App，可以动态的了解所在的宿舍楼人流出入情况，楼层环境情况以及所住的学生基本信息等。

### 1.2  登陆

由于该App主要面向的使用者为宿舍管理员，即职工，所以不涉及注册功能，所有的职工信息有系统管理员在后台输入数据库。职工通过输入**手机号**以及**初始密码**（123456）即可登陆。

对于离职的职工，系统管理员会在后台删除该职工的信息，离职职工无法再登陆。

在登陆模块中，安卓端需获取职工输入的手机号（**tel**）以及密码(**password**)，发送http get请求给服务端，服务端通过查询staff_info表，判断手机号与密码是否匹配。若匹配，则返回该封装了该职工信息的**类对象**；若不匹配否则返回**null**；

staff_info各字段信息如下：

```sql
create table staff_info(
  `num` int comment '员工工号',
  `name` char(30) comment '员工姓名',
  `tel` char(11) comment '员工电话',
  `building_num` tinyint comment '工作所在的宿舍楼号',
  `title` char(30) comment '职称',
  `password` char(30) default '123456' comment 'app登陆密码',
  primary key(num)
)engine=innodb default charset=utf8 comment '宿舍楼职工信息表';
```



### 1.3  默认密码修改

职工登陆App后，可自己修改登陆密码。修改登陆密码时，需先一次输入原密码，完成安全校验后，再输入更新的密码（两次）。

在密码修改模块中，安卓端需先判断用户两次输入的更新密码是否一致，若不一致，弹出提示信息，要求用户重新输入。

但两次输入的更新密码一致后，将职工的**手机号**（tel），**原密码**(oldPassword)与**新密码**(newPassword)通过http post请求发送给服务端，服务端通过查询staff_info表, 判断原密码的是否正确。**若正确，返回1，否则返回-1**；

### 1.4  手机号修改

手机号的修改逻辑类似密码的修改，安卓端需要获取用户的**原手机号**（oldTel），**登陆密码**(password)，**新手机号**（newTel）,发送http post请求给服务端，服务端先判断原手机号与登陆密码是否匹配。**若匹配，返回1，否则返回-1**；

### 1.5  密码找回（附加功能）

此功能可以暂时先不写。对于不写，可以解释为，不将修改密码的权限开放给职工， 职工通过向管理员提交申请，管理员将密码重新置为默认值。

对于写，即将找回密码的权限赋给职工，需要添加一个发送短信的api，通过手机号短信验证找回。该功能我个人在上学期的课设中已经实现，若后续有时间，可以将这块功能完善。

## 2  学生信息模块

### 2.1  基本信息展示

在该模块，宿舍管理员可查询所在宿舍楼的学生信息。

当宿舍管理员点击该部分的按钮时，安卓端将登陆职工的所在的**宿舍楼号**（buildingNum），通过http get请求传给服务端，服务端会根据宿舍楼号查询student_info表，将该楼的所有学生信息，以一个**列表List<Student>，通过Json格式**，返回给返回给安卓端。安卓端可以以**瀑布流**的布局展示学生信息。

student_info各字段信息如下：

```sql
create table student_info(
  `num` int comment '学生学号',
  `name` char(30) comment '学生姓名',
  `school` char(45) comment '所在学院，最多15个汉字',
  `major` char(45) comment '专业名称',
  `teacher_name` char(30) comment '班主任',
  `teacher_tel` char(11) comment '班主任电话',
  `building_num` tinyint comment '所在宿舍楼号',
  `room_num` smallint comment '房间号',
  primary key(num)
) engine=innodb default charset=utf8 comment '学生信息表';
```

### 2.2  信息更新（附加功能）

该模块可暂时先不写，即先不将修改学生信息的权限开放给职工。

## 3  人流管理模块

### 3.1  每日出入刷卡图表显示

在该模块，宿舍管理员可以看到每日出入该宿舍楼的人流情况。

当宿舍管理员点击该部分的按钮时，安卓端将登陆职工的所在的**宿舍楼号**（buildingNum），通过http get请求传给服务端，服务端通过查询访问记录access_info表，将**该楼的该日**的人流情况以一个**列表List<AccessInfo>，通过Json格式**，返回给返回给安卓端。安卓端可以**柱状图**等形式展现，或直接以**表格**的形式展现。

该模块的信息是动态变化的，为了节省资源消耗，初步设置为宿舍管理员每点击一次，系统就查询一次，更新信息。

access_info各字段信息如下：

```sql
create table access_info(
  `building_num` tinyint comment '出入的宿舍楼号',
  `student_num` int comment '学生学号',
  `access_time` timestamp default current_timestamp comment '出入时间',
  `access_status` tinyint comment'出入状态，入:1 出-1',
  primary key(building_num, student_num, access_time)
) engine=innodb default charset=utf8 comment '学生出入宿舍楼记录表';
```

### 3.2  异常出入信息显示

在该模块，宿舍管理员可以看到非该宿舍楼的同学尝试访问的记录，实现逻辑同上。

当宿舍管理员点击该部分的按钮时，安卓端将登陆职工的所在的**宿舍楼号**（buildingNum），通过http get请求传给服务端，服务端通过查询被阻访问记录block_info表，将**该楼的该日**的异常访问情况以一个**列表List<BlockInfo>，通过Json格式**，返回给返回给安卓端。安卓端可以直接以**表格**的形式展现。

block_info各字段信息如下：

```sql
create table block_info(
  `building_num` tinyint comment '出入的宿舍楼号',
  `student_num` int comment '学生学号',
  `access_time`  timestamp default current_timestamp comment '出入时间',
  primary key(building_num, student_num, access_time)
) engine=innodb default charset=utf8 comment '被阻访问记录表';
```



### 3.3  学生未归寝提醒

在该模块，宿舍管理员通过设置门禁时间（如周一至周五晚11点，周末晚11：30），当到达门禁时间时，安卓端**自动**将登陆职工的所在的**宿舍楼号**（buildingNum），通过http get请求，发送给服务端。服务端通过查询access_info表，将未归寝的学生名单以一个**列表List<BlockInfo>，通过Json格式****，返回给返回给安卓端。安卓端可以通过**消息弹窗**的形式提醒宿舍管理员，并以列表的形式显示在app界面中，供查询。

## 4  环境监控模块

### 4.1  每日温湿度图表显示

在该模块，宿舍管理员可查询该宿舍楼的温湿度情况。

当宿舍管理员点击该部分的按钮时，安卓端将登陆职工的所在的**宿舍楼号**（buildingNum），通过http get请求传给服务端，服务端通过查询温湿度数据humiture_info表，将**该楼的该日**的温湿度以一个**列表List<HumitureInfo>，通过Json格式**，返回给返回给安卓端。安卓端可以**折线图**等形式展现。为方便测量，温湿度默认是**每分钟**采集一次，折线图的单位可按**每小时**进行模拟。

humiture_info表的各个字段如下：

```sql
create table humiture_info(
   `mac_address` char(16) comment '传感器的MAC地址',
   `collect_time`  timestamp default current_timestamp comment '采集的时间',
   `temperature` float comment '温度，单位摄氏度',
   `humidity` float comment '相对湿度，单位',
   primary key(mac_address, collect_time)
) engine=innodb default charset=utf8 comment '温湿度数据表';
```

sensors_info表的各个字段如下：

```sql
create table sensors_info(
   `mac_address` char(16) comment '传感器的MAC地址',
   `building_num` tinyint comment '所在的宿舍楼号',
   `location` char(15) comment '楼内的位置，如二层东',
    primary key(mac_address)
) engine=innodb default charset=utf8 comment '传感器信息表';
```

该模块的信息是动态变化的，为了节省资源消耗，初步设置为宿舍管理员每点击一次，系统就查询一次，更新信息。

### 4.2  温湿度异常信息提醒（后续补充）